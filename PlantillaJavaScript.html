<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<script>
  // Instancia global para poder acceder al menú desde cualquier función
  let mdcDrawerInstance = null;

  /**
   * Carga el contenido de una página dinámicamente, ejecuta sus scripts y cierra el menú.
   */
  function loadPage(pageName, clickedElement) {
    const contentArea = document.getElementById('main-content-area');
    if (contentArea) {
      contentArea.innerHTML = '<div style="text-align:center; padding: 40px;">Cargando...</div>'; 
    }
    google.script.run
      .withSuccessHandler(function(htmlContent) {
        if (contentArea) {
          contentArea.innerHTML = htmlContent;
          // Ejecuta los scripts de la página cargada dinámicamente
          const scripts = Array.from(contentArea.getElementsByTagName('script'));
          scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            newScript.textContent = oldScript.textContent;
            document.body.appendChild(newScript).parentNode.removeChild(newScript);
            oldScript.parentNode.removeChild(oldScript);
          });
        }
        
        // Marca el enlace activo en el menú
        document.querySelectorAll('#main-nav .mdc-list-item').forEach(item => item.classList.remove('mdc-list-item--activated'));
        if (clickedElement) clickedElement.classList.add('mdc-list-item--activated');

        // Cierra el menú lateral si está abierto
        if (mdcDrawerInstance && mdcDrawerInstance.open) {
          mdcDrawerInstance.open = false;
        }
        // --- FIN DE LA CORRECCIÓN ---

      })
      .withFailureHandler(function(error) {
        if (contentArea) contentArea.innerHTML = `<div style="text-align:center; padding: 40px; color: red;">Error: ${error.message}</div>`;
      })
      .getPageContent(pageName);
  }

  /**
   * Se ejecuta una sola vez cuando la aplicación carga por primera vez.
   */
  document.addEventListener('DOMContentLoaded', function() {
    const drawerElement = document.querySelector('.mdc-drawer');
    const menuButton = document.querySelector('.mdc-top-app-bar__navigation-icon');
    
    // Inicializa los efectos "ripple" de Material Design
    Array.from(document.querySelectorAll('.mdc-button, .mdc-icon-button, .mdc-list-item')).forEach(el => mdc.ripple.MDCRipple.attachTo(el));
    
    if (drawerElement && menuButton) {
      mdcDrawerInstance = mdc.drawer.MDCDrawer.attachTo(drawerElement);
      menuButton.addEventListener('click', () => { mdcDrawerInstance.open = !mdcDrawerInstance.open; });
      console.log("Menú y botón conectados correctamente.");
    }

    // Carga la página de inicio al arrancar
    const firstNavLink = document.querySelector('#main-nav a[onclick*="inicio"]');
    loadPage('inicio', firstNavLink || null); 
  });
</script>