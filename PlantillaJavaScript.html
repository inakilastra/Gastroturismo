<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<script>
  // Instancia global para poder acceder al menú desde cualquier función
  let mdcDrawerInstance = null;

  /**
   * HTML para el indicador de carga visual.
   * AHORA USA EL NUEVO SPINNER SIMPLE (simple-loader).
   */
  const loadingSpinnerHtml = `
    <div style="padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: calc(100vh - 128px);">
      <div class="simple-loader" role="progressbar" aria-label="Cargando"></div>
      <p style="font-size: 1.5rem; color: var(--mdc-theme-primary); margin-top: 16px;">Cargando...</p>
    </div>
  `;

  /**
   * Carga el contenido de una página dinámicamente.
   * La lógica de inicialización del spinner ha sido eliminada porque ya no es necesaria.
   */
  function loadPage(pageName, clickedElement) {
    console.log(`[DEBUG] Iniciando loadPage para: '${pageName}'`);

    const contentArea = document.getElementById('main-content-area');
    if (contentArea) {
      contentArea.innerHTML = loadingSpinnerHtml;
      console.log("[DEBUG] HTML del spinner simple inyectado.");
    }
    
    google.script.run
      .withSuccessHandler(function(htmlContent) {
        console.log(`[DEBUG] Carga de '${pageName}' completada (SuccessHandler).`);
        if (contentArea) {
          contentArea.innerHTML = htmlContent;
          const scripts = Array.from(contentArea.getElementsByTagName('script'));
          scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            newScript.textContent = oldScript.textContent;
            document.body.appendChild(newScript).parentNode.removeChild(newScript);
            if (oldScript.parentNode) {
              oldScript.parentNode.removeChild(oldScript);
            }
          });
        }
        
        document.querySelectorAll('#main-nav .mdc-list-item').forEach(item => item.classList.remove('mdc-list-item--activated'));
        if (clickedElement) clickedElement.classList.add('mdc-list-item--activated');

        if (mdcDrawerInstance && mdcDrawerInstance.open) {
          mdcDrawerInstance.open = false;
        }
      })
      .withFailureHandler(function(error) {
        console.error(`[DEBUG] Fallo al cargar '${pageName}':`, error);
        if (contentArea) contentArea.innerHTML = `<div style="text-align:center; padding: 40px; color: red;">Error: ${error.message}</div>`;
      })
      .getPageContent(pageName);
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log("[DEBUG] DOMContentLoaded disparado. Inicializando componentes estáticos.");
    const drawerElement = document.querySelector('.mdc-drawer');
    const menuButton = document.querySelector('.mdc-top-app-bar__navigation-icon');
    
    Array.from(document.querySelectorAll('.mdc-button, .mdc-icon-button, .mdc-list-item')).forEach(el => mdc.ripple.MDCRipple.attachTo(el));
    
    if (drawerElement && menuButton) {
      mdcDrawerInstance = mdc.drawer.MDCDrawer.attachTo(drawerElement);
      menuButton.addEventListener('click', () => { mdcDrawerInstance.open = !mdcDrawerInstance.open; });
    }

    const firstNavLink = document.querySelector('#main-nav a[onclick*="inicio"]');
    loadPage('inicio', firstNavLink || null); 
  });
</script>