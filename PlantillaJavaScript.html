<!-- PlantillaJavaScript.html -->
<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<script>
  let mdcDrawerInstance = null;

  /**
   * Carga el contenido de una página dinámicamente.
   * ESTA VERSIÓN INCLUYE LA CORRECCIÓN PARA EJECUTAR SCRIPTS.
   */
  function loadPage(pageName, clickedElement) {
    const contentArea = document.getElementById('main-content-area');
    if (contentArea) {
      contentArea.innerHTML = '<div style="text-align:center; padding: 40px;">Cargando...</div>'; 
    }

    google.script.run
      .withSuccessHandler(function(htmlContent) {
        if (contentArea) {
          // 1. Insertamos el HTML como antes.
          contentArea.innerHTML = htmlContent;

          // --- INICIO DE LA CORRECCIÓN ---
          // 2. Buscamos todas las etiquetas <script> que acabamos de insertar.
          const scripts = Array.from(contentArea.getElementsByTagName('script'));
          
          scripts.forEach(oldScript => {
            // 3. Creamos una nueva etiqueta <script> y copiamos el contenido de la antigua.
            const newScript = document.createElement('script');
            newScript.textContent = oldScript.textContent;
            
            // 4. Añadimos la nueva etiqueta al final del body. El navegador la ejecutará.
            document.body.appendChild(newScript);
            
            // 5. Eliminamos la etiqueta original que no se ejecutó.
            oldScript.parentNode.removeChild(oldScript);
          });
          // --- FIN DE LA CORRECCIÓN ---
        }
        
        // El resto de la lógica para activar el menú, etc.
        document.querySelectorAll('#main-nav .mdc-list-item').forEach(item => {
          item.classList.remove('mdc-list-item--activated');
        });
        if (clickedElement) {
          clickedElement.classList.add('mdc-list-item--activated');
        }

        if (mdcDrawerInstance && mdcDrawerInstance.open) {
          mdcDrawerInstance.open = false;
        }
      })
      .withFailureHandler(function(error) {
        if (contentArea) {
          contentArea.innerHTML = `<div style="text-align:center; padding: 40px; color: red;">Error al cargar la página: ${error.message}</div>`;
        }
      })
      .getPageContent(pageName);
  }

  /**
   * Se ejecuta una sola vez cuando el documento HTML inicial está listo.
   */
  document.addEventListener('DOMContentLoaded', function() {
    const drawerElement = document.querySelector('.mdc-drawer');
    const menuButton = document.querySelector('.mdc-top-app-bar__navigation-icon');
    
    const ripples = Array.from(document.querySelectorAll('.mdc-button, .mdc-icon-button, .mdc-list-item'));
    ripples.forEach(el => mdc.ripple.MDCRipple.attachTo(el));

    if (drawerElement && menuButton) {
      mdcDrawerInstance = mdc.drawer.MDCDrawer.attachTo(drawerElement);
      menuButton.addEventListener('click', () => { mdcDrawerInstance.open = !mdcDrawerInstance.open; });
      console.log("Menú y botón conectados correctamente.");
    }

    const firstNavLink = document.querySelector('#main-nav a[onclick*="inicio"]');
    if (firstNavLink) {
      loadPage('inicio', firstNavLink); 
    } else {
      loadPage('inicio', null);
    }
  });
</script>
