<div class="mdc-top-app-bar--fixed-adjust">
  <div class="page-container section-padding">
    <div id="tapeo-selector">
      <div id="tapeo-header" style="margin-bottom: 20px;">
        <div style="display: flex; align-items: center; min-height: 40px; margin-bottom: 16px;">
          <button id="tapeo-back-button" class="mdc-button mdc-button--raised" style="display: none;" onclick="tapeo.goBack()">
            <span class="mdc-button__ripple"></span>
            <i class="material-icons mdc-button__icon" aria-hidden="true">arrow_back</i>
            <span class="mdc-button__label">ATRÁS</span>
          </button>
          <div id="tapeo-breadcrumbs" style="margin-left: 16px; font-size: 1rem; opacity: 0.7;"></div>
        </div>
        <h2 id="tapeo-title" class="section-title" style="text-align: left; margin: 0;"></h2>
      </div>
      <div id="tapeo-grid" class="grid-container" style="display: none;"></div>
      
      <div id="tapeo-loading" style="padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div class="simple-loader" role="progressbar" aria-label="Cargando"></div>
        <p style="font-size: 1.5rem; color: var(--mdc-theme-primary); margin-top: 16px;">Cargando...</p>
      </div>
      
    </div>
  </div>
</div>
<script>
  window.INITIAL_TAPEODATA = <?!= initialData ?>;

  (function() {
    const state = { level: 'autonomias', selection: {}, history: [] };
    const elements = { title: document.getElementById('tapeo-title'), grid: document.getElementById('tapeo-grid'), loading: document.getElementById('tapeo-loading'), backButton: document.getElementById('tapeo-back-button'), breadcrumbs: document.getElementById('tapeo-breadcrumbs') };
    const levelsConfig = { autonomias: { title: 'Donde quieres ir de pintxos o tapas?', icon: 'public', next: 'provincias' }, provincias: { title: 'Selecciona una Provincia', icon: 'map', next: 'ciudades' }, ciudades: { title: 'Selecciona una Ciudad', icon: 'location_city', next: 'barrios' }, barrios: { title: 'Selecciona un Barrio', icon: 'storefront', next: 'sitios' }, sitios: { title: 'Sitios para Tapear', icon: 'tapas', next: null } };

    // La función generateRatingHearts se ha eliminado porque ya no es necesaria.

    function renderBreadcrumbs() { if (!elements.breadcrumbs) return; const crumbs = []; if (state.selection.autonomia) crumbs.push(state.selection.autonomia); if (state.selection.provincia && state.selection.provincia !== state.selection.autonomia) crumbs.push(state.selection.provincia); if (state.selection.ciudad && state.selection.ciudad !== state.selection.provincia) crumbs.push(state.selection.ciudad); if (state.selection.barrio && state.selection.barrio !== state.selection.ciudad) crumbs.push(state.selection.barrio); elements.breadcrumbs.innerHTML = crumbs.join(' <span style="font-weight: bold;"> &gt; </span> '); }
    
    function populateGrid(data) { 
      if (!elements.grid) return; 
      renderBreadcrumbs(); 
      elements.title.textContent = levelsConfig[state.level].title; 
      elements.grid.innerHTML = ''; 
      const config = levelsConfig[state.level]; 
      data.forEach(item => { 
        let cardHtml = ''; 
        if (state.level === 'sitios') {
          // Determina el enlace principal para el botón "+ INFO"
          const primaryLink = item.postnstagram || item.web || item.instagram || item.maps;
          
          // Construye la tarjeta del sitio
          cardHtml = `
            <div class="sitio-card" style="grid-column: 1 / -1;">
              ${item.foto1 ? `<div class="sitio-card-image" style="background-image: url('${item.foto1}');"></div>` : ''}
              <div class="sitio-card-info">
                <h3>${item.nombre || 'Nombre no disponible'}</h3>
                <div class="sitio-card-rating">${item.valoracion || ''}</div>
                <div class="sitio-card-description">${item.pintxo_tapa || ''}</div>
                ${primaryLink ? `<button class="mdc-button mdc-button--raised" onclick="location.href='${primaryLink}'" type="button">
                  <span class="mdc-button__ripple"></span>
                  <i class="material-icons mdc-button__icon" aria-hidden="true">info</i>
                  <span class="mdc-button__label">+ info</span>
                </button>` : ''}
              </div>
            </div>
          `;
        } else { 
          cardHtml = `<div class="mdc-card category-card" onclick="tapeo.handleSelection('${item}')"><div class="mdc-card__primary-action mdc-ripple-upgraded" style="cursor: pointer;"><div class="category-card__icon-container"><i class="material-icons">${config.icon}</i></div><h3 class="category-card__title">${item}</h3></div></div>`; 
        } 
        elements.grid.insertAdjacentHTML('beforeend', cardHtml); 
      }); 
    }
    
    // El resto de las funciones no necesitan cambios
    function handleDataSuccess(data) { if (typeof mdcDrawerInstance !== 'undefined' && mdcDrawerInstance && mdcDrawerInstance.open) { mdcDrawerInstance.open = false; } showLoading(false); if (!Array.isArray(data)) { displayError('Respuesta inesperada del servidor.'); return; } if (state.level === 'barrios' && data.length > 1) { data.unshift('Todos'); } const isSkipping = data.length === 1 && state.level !== 'sitios'; state.history.push({ level: state.level, selection: { ...state.selection }, skipped: isSkipping }); if (isSkipping) { handleSelection(data[0]); } else { populateGrid(data); } }
    function handleFailure(error) { if (typeof mdcDrawerInstance !== 'undefined' && mdcDrawerInstance && mdcDrawerInstance.open) { mdcDrawerInstance.open = false; } showLoading(false); displayError(`La llamada al servidor falló: ${error.message}`); }
    function handleSelection(selectionName) { let key = (state.level === 'ciudades') ? 'ciudad' : state.level.slice(0, -1); if (state.level === 'barrios' && selectionName === 'Todos') { /* No hacer nada */ } else { state.selection[key] = selectionName; } state.level = levelsConfig[state.level].next; if (state.level) { renderStep(); } }
    function renderStep() { showLoading(true); elements.backButton.style.display = (state.history.length > 0) ? 'inline-flex' : 'none'; google.script.run.withSuccessHandler(handleDataSuccess).withFailureHandler(handleFailure).getTapeoData(state.level, state.selection); }
    function goBack() { state.history.pop(); let lastState = state.history.pop(); while (lastState && lastState.skipped) { lastState = state.history.pop(); } if (lastState) { state.level = lastState.level; state.selection = lastState.selection; renderStep(); } else { state.level = 'autonomias'; state.selection = {}; state.history = []; if (elements.breadcrumbs) elements.breadcrumbs.innerHTML = ''; renderStep(); } }
    function initWithPreloadedData() { if (!window.INITIAL_TAPEODATA) { displayError("No se recibieron los datos iniciales."); return; } if (elements.breadcrumbs) elements.breadcrumbs.innerHTML = ''; showLoading(false); handleDataSuccess(window.INITIAL_TAPEODATA); delete window.INITIAL_TAPEODATA; }
    function displayError(message) { if (elements.grid) { elements.grid.style.display = 'block'; elements.grid.innerHTML = `<div style="color: red; padding: 20px;"><h3>Error en la aplicación</h3><p>${message}</p></div>`; } if (elements.loading) elements.loading.style.display = 'none'; }
    function showLoading(isLoading) { if(elements.loading) elements.loading.style.display = isLoading ? 'flex' : 'none'; if(elements.grid) elements.grid.style.display = isLoading ? 'none' : 'grid'; }
    
    window.tapeo = { handleSelection, goBack };
    initWithPreloadedData();
  })();
</script>
