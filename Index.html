<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ANeKI - GastroTurismo Moderno</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <?!= include('css'); ?>
</head>
<body class="mdc-typography">

  <header class="mdc-top-app-bar">
    <div class="mdc-top-app-bar__row">
      <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
        <button id="menu-button" class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button" aria-label="Abrir menú de navegación" style="display:none;">menu</button>
        <span class="mdc-top-app-bar__title">GastroTurismo</span>
      </section>
      <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
        </section>
    </div>
  </header>
  <div class="mdc-top-app-bar--fixed-adjust">
    <main class="main-content mdc-padding--16">
      <nav id="breadcrumb-nav" aria-label="breadcrumb" style="margin-bottom: 16px;">
      </nav>

      <div id="page-header-container" style="display: flex; align-items: center; margin-bottom: 16px;">
        <button id="main-back-button" class="mdc-button mdc-button--outlined" style="display: none; margin-right: 16px;">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Volver</span>
        </button>
        <h1 id="page-title" class="mdc-typography--headline4" style="margin-bottom: 0;">Bienvenido</h1>
      </div>
      
      <div id="list-container" class="mdc-layout-grid">
        <div class="mdc-layout-grid__inner">
        </div>
      </div>

      <div id="site-detail-container" style="display:none;">
      </div>

      <div id="loader" class="mdc-linear-progress mdc-linear-progress--indeterminate" role="progressbar" style="display:none;">
        <div class="mdc-linear-progress__buffer">
          <div class="mdc-linear-progress__buffer-bar"></div>
          <div class="mdc-linear-progress__buffer-dots"></div>
        </div>
        <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
          <span class="mdc-linear-progress__bar-inner"></span>
        </div>
        <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
          <span class="mdc-linear-progress__bar-inner"></span>
        </div>
      </div>

    </main>
  </div>

  <div id="snackbar" class="mdc-snackbar">
    <div class="mdc-snackbar__surface" role="status" aria-relevant="additions text">
      <div class="mdc-snackbar__label" aria-atomic="false">
        Mensaje aquí.
      </div>
      <div class="mdc-snackbar__actions" aria-atomic="true">
        <button type="button" class="mdc-button mdc-snackbar__action">
          <div class="mdc-button__ripple"></div>
          <span class="mdc-button__label">Cerrar</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Inicializar componentes MDC
    const topAppBar = new mdc.topAppBar.MDCTopAppBar(document.querySelector('.mdc-top-app-bar'));
    const snackbar = new mdc.snackbar.MDCSnackbar(document.getElementById('snackbar'));
    const linearProgress = new mdc.linearProgress.MDCLinearProgress(document.getElementById('loader'));
    
    const menuButton = document.getElementById('menu-button'); 
    const mainBackButton = document.getElementById('main-back-button'); // Referencia al nuevo botón
    if (mainBackButton) { // Inicializar ripple para el nuevo botón
        new mdc.ripple.MDCRipple(mainBackButton);
    }

    const pageTitle = document.getElementById('page-title');
    const listContainer = document.getElementById('list-container').querySelector('.mdc-layout-grid__inner');
    const siteDetailContainer = document.getElementById('site-detail-container');
    const breadcrumbNav = document.getElementById('breadcrumb-nav');

    let currentLevel = 'autonomias'; 
    let currentFilters = {}; 
    let breadcrumbs = []; 
    let currentPhotoIndex = 0;
    let photoElements = [];


    // --- Funciones de Carga y Mensajes ---
    function showLoader() {
      document.getElementById('loader').style.display = 'block';
      linearProgress.open();
    }

    function hideLoader() {
      linearProgress.close();
      document.getElementById('loader').style.display = 'none';
    }

    function showMessage(message) {
      snackbar.labelText = message;
      snackbar.open();
    }

    // --- Navegación por Migas de Pan y Botón Volver ---
    function updateBreadcrumbs() {
      breadcrumbNav.innerHTML = ''; // Limpiar migas de pan anteriores

      // Configuración de los botones "Volver"
      if (breadcrumbs.length <= 1 && currentLevel !== 'sitio_detail') { 
         menuButton.style.display = 'none'; 
         if(mainBackButton) mainBackButton.style.display = 'none'; // Ocultar botón "Volver" de main

         // Restaurar menuButton a icono de menú (si fuera necesario, aunque aquí no se usa como tal)
         // Asegurarse de que tenga la clase material-icons si se va a mostrar como icono
         if (!menuButton.classList.contains('material-icons')) {
            menuButton.classList.add('material-icons');
         }
         menuButton.textContent = 'menu'; 
         menuButton.setAttribute('aria-label', 'Abrir menú de navegación');
      } else {
         // Mostrar botón de flecha atrás en la top-app-bar
         menuButton.style.display = 'inline-flex'; 
         if (!menuButton.classList.contains('material-icons')) { // Asegurar que sea un icono
            menuButton.classList.add('material-icons');
         }
         menuButton.textContent = 'arrow_back'; 
         menuButton.setAttribute('aria-label', 'Volver atrás');
         menuButton.onclick = goBack;

         // Mostrar botón "Volver" de texto en el main
         if(mainBackButton) {
            mainBackButton.style.display = 'inline-block'; // o 'flex' si prefieres
            mainBackButton.onclick = goBack;
         }
      }
      
      // No mostrar migas de pan si solo es "Inicio" y no estamos en detalle de sitio,
      // o si no hay breadcrumbs (aunque el primer caso ya lo cubre)
      if (breadcrumbs.length === 0 || (breadcrumbs.length === 1 && breadcrumbs[0].level === 'autonomias' && currentLevel !== 'sitio_detail')) {
         // No renderizar la lista de migas de pan si estamos en el nivel superior
         // y no es un detalle de sitio (el detalle de sitio siempre muestra su miga completa)
         return; 
      }

      const ol = document.createElement('ol');
      ol.className = 'breadcrumb'; 
      breadcrumbs.forEach((crumb, index) => {
        const li = document.createElement('li');
        li.className = 'breadcrumb-item';
        if (index === breadcrumbs.length - 1) {
          li.textContent = crumb.label;
          li.setAttribute('aria-current', 'page');
        } else {
          const a = document.createElement('a');
          a.href = '#'; 
          a.textContent = crumb.label;
          a.onclick = (e) => {
            e.preventDefault();
            breadcrumbs = breadcrumbs.slice(0, index + 1);
            currentLevel = crumb.level;
            currentFilters = { ...crumb.filters }; 
            pageTitle.textContent = crumb.label === 'Inicio' ? 'Autonomía/País' : crumb.label;
            
            if (crumb.level === 'autonomias') loadAutonomias();
            else if (crumb.level === 'provincias') loadProvincias(crumb.filters.autonomia);
            else if (crumb.level === 'ciudades') loadCiudades(crumb.filters.provincia);
            else if (crumb.level === 'barrios') loadBarrios(crumb.filters.ciudad);
            updateBreadcrumbs(); 
          };
          li.appendChild(a);
        }
        ol.appendChild(li);
        if (index < breadcrumbs.length - 1) {
          const separator = document.createElement('span');
          separator.className = 'breadcrumb-separator';
          separator.textContent = '>'; 
          separator.style.margin = "0 8px";
          ol.appendChild(separator);
        }
      });
      breadcrumbNav.appendChild(ol);
    }
    
    function goBack() {
        if (breadcrumbs.length > 1) {
            breadcrumbs.pop(); 
            const targetCrumb = breadcrumbs[breadcrumbs.length - 1]; 

            currentLevel = targetCrumb.level;
            currentFilters = { ...targetCrumb.filters };
            pageTitle.textContent = targetCrumb.label === 'Inicio' ? 'Autonomía/País' : targetCrumb.label;

            if (targetCrumb.level === 'autonomias') {
                loadAutonomias();
            } else if (targetCrumb.level === 'provincias') {
                loadProvincias(targetCrumb.filters.autonomia);
            } else if (targetCrumb.level === 'ciudades') {
                loadCiudades(targetCrumb.filters.provincia);
            } else if (targetCrumb.level === 'barrios') {
                loadBarrios(targetCrumb.filters.ciudad);
            } else if (targetCrumb.level === 'sitios') {
                if (targetCrumb.filters && targetCrumb.filters.barrio) {
                    loadSitios(targetCrumb.filters.barrio);
                } else {
                    console.error("Error en goBack: No se encontró el filtro de barrio para el nivel 'sitios'.");
                    loadAutonomias(); 
                }
            }
            updateBreadcrumbs();
        }
    }

    // --- Funciones de Renderizado ---
    function renderList(items, type) { 
      listContainer.innerHTML = ''; 
      siteDetailContainer.style.display = 'none';
      listContainer.style.display = 'grid'; 

      if (!items || items.length === 0) {
        listContainer.innerHTML = `<p class="mdc-typography--body1 mdc-layout-grid__cell--span-12">No hay ${type}s disponibles.</p>`;
        return;
      }

      // Añadido itemIndex para generar IDs únicos para las imágenes y loaders
      items.forEach((itemData, itemIndex) => { 
        const value = itemData[capitalizeFirstLetter(type)]; 
        if (!value && type !== 'sitio') return; 
        
        const name = type === 'sitio' ? itemData.Nombre : value;
        if(!name) return; 

        const cell = document.createElement('div');
        cell.className = 'mdc-layout-grid__cell mdc-layout-grid__cell--span-4-desktop mdc-layout-grid__cell--span-6-tablet mdc-layout-grid__cell--span-12-phone';

        const card = document.createElement('div');
        card.className = 'mdc-card mdc-card--outlined';
        card.style.width = '100%';
        card.style.marginBottom = '16px';

        const primaryAction = document.createElement('div');
        primaryAction.className = 'mdc-card__primary-action';
        primaryAction.style.flexDirection = 'column'; // Para que la imagen y el texto se apilen
        primaryAction.style.alignItems = 'stretch'; // Para que la imagen ocupe el ancho
        primaryAction.tabIndex = 0;
        
        let cardContentHTML = ''; // Iniciar vacío, construiremos con divs separados para mejor control

        // Contenedor para la imagen (solo para sitios y si Foto1 existe)
        if (type === 'sitio' && itemData.Foto1) {
          cardContentHTML += `<div id="list-thumb-loader-${itemIndex}" class="list-thumbnail-loader" style="width:100%; height:150px; background-color:#f0f0f0; display:flex; align-items:center; justify-content:center; margin-bottom:0px; border-top-left-radius: 12px; border-top-right-radius: 12px;">Cargando...</div>`;
          cardContentHTML += `<img id="list-thumb-img-${itemIndex}" src="" alt="Miniatura de ${itemData.Nombre || 'sitio'}" style="display:none; width:100%; height:150px; object-fit:cover; border-top-left-radius: 12px; border-top-right-radius: 12px;">`;
        }
        
        // Contenedor para el texto
        cardContentHTML += `<div style="padding: 16px;">`; // Padding solo para la sección de texto
        if (type === 'sitio') {
          cardContentHTML += `<h2 class="mdc-typography--headline6" style="margin: 0 0 8px 0;">${itemData.Nombre || 'Sin nombre'}`;
          if (itemData.Valoracion) cardContentHTML += ` ${itemData.Valoracion}`;
          cardContentHTML += `</h2>`;
          if (itemData.GoogleResenas && itemData.GoogleResenas.startsWith('http')) {
            cardContentHTML += `<a href="${itemData.GoogleResenas}" target="_blank" class="mdc-button mdc-button--outlined"><span class="mdc-button__ripple"></span><span class="mdc-button__label">Reseñas Google</span></a>`;
          }   
  
          if (itemData.Tipo_Lugar) cardContentHTML += `<h3 class="mdc-typography--subtitle2" style="color: var(--mdc-theme-on-surface-variant); margin:0 0 8px 0; font-size: 0.8rem;">${itemData.Tipo_Lugar}</h3>`;
          if (itemData.Pintxo_Tapa) {
            const pintxoTapaConSaltos = itemData.Pintxo_Tapa.replace(/\n/g, '<br>');
            cardContentHTML += `<p class="mdc-typography--caption" style="margin:0; font-size: 0.75rem;">${pintxoTapaConSaltos}</p>`;
          }
          
        } else {
          cardContentHTML += `<h2 class="mdc-typography--headline6" style="margin: 0;">${name}</h2>`;
        }
        cardContentHTML += `</div>`; // Cierre del div de padding para texto
        
        primaryAction.innerHTML = cardContentHTML;

        primaryAction.onclick = () => {
          if (type === 'autonomia') loadProvincias(name);
          else if (type === 'provincia') loadCiudades(name);
          else if (type === 'ciudad') loadBarrios(name);
          else if (type === 'barrio') loadSitios(name);
          else if (type === 'sitio') showSiteDetail(itemData);
        };

        card.appendChild(primaryAction);
        cell.appendChild(card);
        listContainer.appendChild(cell);
        new mdc.ripple.MDCRipple(primaryAction);

        // Cargar la miniatura asíncronamente si es un sitio y tiene Foto1
        if (type === 'sitio' && itemData.Foto1) {
            const thumbImgElement = document.getElementById(`list-thumb-img-${itemIndex}`);
            const thumbLoaderElement = document.getElementById(`list-thumb-loader-${itemIndex}`);
            if (thumbImgElement && thumbLoaderElement) {
                google.script.run
                    .withSuccessHandler(function(base64Image) {
                        if (thumbLoaderElement) thumbLoaderElement.style.display = 'none';
                        if (base64Image) {
                            thumbImgElement.src = base64Image;
                            thumbImgElement.style.display = 'block';
                        } else {
                            thumbImgElement.style.display = 'none'; 
                            console.warn("No se recibió base64 para miniatura (ID: " + itemData.Foto1 + "). El elemento de imagen será ocultado.");
                        }
                    })
                    .withFailureHandler(function(error) {
                        if (thumbLoaderElement) thumbLoaderElement.style.display = 'none';
                        thumbImgElement.style.display = 'none';
                        console.error("Error cargando miniatura " + itemData.Foto1 + ": " + error.message);
                    })
                    .getImageAsBase64(itemData.Foto1);
            }
        }
      }); // Fin de items.forEach
    }

    function showSiteDetail(sitioData) {
      currentLevel = 'sitio_detail';
      pageTitle.textContent = sitioData.Nombre || "Detalle del Sitio";
      listContainer.style.display = 'none'; 
      siteDetailContainer.innerHTML = ''; 
      siteDetailContainer.style.display = 'block'; 

      let detailHTML = `<div class="mdc-card mdc-card--outlined" style="padding:16px;">`;
      detailHTML += `<h2 class="mdc-typography--headline5">${sitioData.Nombre || 'Sin nombre'}`;
      if (sitioData.Valoracion) detailHTML += ` ${sitioData.Valoracion}`; 
      detailHTML += `</h2>`;
      if (sitioData.Tipo_Lugar) detailHTML += `<p class="mdc-typography--subtitle1" style="color: var(--mdc-theme-on-surface-variant);">${sitioData.Tipo_Lugar}</p>`; 
      if (sitioData.Nota) detailHTML += `<p class="mdc-typography--body1">${sitioData.Nota}</p>`;
      if (sitioData.Direccion) detailHTML += `<p class="mdc-typography--body1"><span class="material-icons" style="vertical-align: bottom;">place</span> ${sitioData.Direccion}</p>`;
      if (sitioData.Horario) detailHTML += `<p class="mdc-typography--body1"><span class="material-icons" style="vertical-align: bottom;">schedule</span> ${sitioData.Horario}</p>`;
      if (sitioData.Pintxo_Tapa) {
        const pintxoTapaConSaltos = sitioData.Pintxo_Tapa.replace(/\n/g, '<br>');
        detailHTML += `<p class="mdc-typography--caption" style="margin:0; font-size: 0.75rem;">${pintxoTapaConSaltos}</p>`;
      }

      const fotoIds = [sitioData.Foto1, sitioData.Foto2, sitioData.Foto3, sitioData.Foto4].filter(Boolean);
      photoElements = []; 

      if (fotoIds.length > 0) {
        detailHTML += `<h3 class="mdc-typography--headline6" style="margin-top:24px; margin-bottom: 12px;">Galería</h3>`;
        detailHTML += `<div class="carousel-container">`;
        fotoIds.forEach((idFoto, index) => {
          detailHTML += `<div class="carousel-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
                           <img id="carousel-img-${index}" src="" alt="Foto ${index + 1} de ${sitioData.Nombre}" style="display:none; width:100%; height:auto; max-height: 450px; object-fit: contain;">
                           <div id="carousel-loader-${index}" class="image-loader-placeholder" style="display:flex; align-items:center; justify-content:center; height:300px; background-color:#eee;">Cargando foto...</div>
                         </div>`;
        });
        detailHTML += `<button class="carousel-button prev" onclick="changePhoto(-1)">&#10094;</button>`;
        detailHTML += `<button class="carousel-button next" onclick="changePhoto(1)">&#10095;</button>`;
        detailHTML += `</div>`;
      }
      
      detailHTML += `<div style="margin-top: 24px;">`;
      if (sitioData.Maps) detailHTML += `<a href="${sitioData.Maps}" target="_blank" class="mdc-button mdc-button--outlined" style="margin-right: 8px;"><span class="mdc-button__ripple"></span><span class="material-icons mdc-button__icon" aria-hidden="true">map</span><span class="mdc-button__label">Como llegar</span></a>`;
      if (sitioData.Web) detailHTML += `<a href="${sitioData.Web}" target="_blank" class="mdc-button mdc-button--outlined" style="margin-right: 8px;"><span class="mdc-button__ripple"></span><span class="material-icons mdc-button__icon" aria-hidden="true">language</span><span class="mdc-button__label">Sitio Web</span></a>`;
      if (sitioData.Facebook) detailHTML += `<a href="${sitioData.Facebook}" target="_blank" class="mdc-button mdc-button--outlined" style="margin-right: 8px;"><span class="mdc-button__ripple"></span><span class="material-icons mdc-button__icon" aria-hidden="true">groups</span><span class="mdc-button__label">Facebook</span></a>`; 
      if (sitioData.Instagram) detailHTML += `<a href="${sitioData.Instagram}" target="_blank" class="mdc-button mdc-button--outlined"><span class="mdc-button__ripple"></span><span class="mdc-button__label">Instagram</span></a>`; 
      detailHTML += `</div>`;
      detailHTML += `</div>`; 
      siteDetailContainer.innerHTML = detailHTML;
      
      const mdcButtonsInDetail = siteDetailContainer.querySelectorAll('.mdc-button');
      mdcButtonsInDetail.forEach(button => new mdc.ripple.MDCRipple(button));

      if (fotoIds.length > 0) {
        fotoIds.forEach((idFoto, index) => {
          if (!idFoto) return;
          const imgElement = document.getElementById(`carousel-img-${index}`);
          const loaderElement = document.getElementById(`carousel-loader-${index}`);
          google.script.run
            .withSuccessHandler(function(base64Image) {
              if (loaderElement) loaderElement.style.display = 'none';
              if (imgElement && base64Image) {
                imgElement.src = base64Image;
                imgElement.style.display = '';
              } else if (imgElement) {
                imgElement.alt = "Error al cargar imagen (ID: " + idFoto + ")";
                imgElement.style.display = '';
                console.error("No se recibió base64Image para el ID:", idFoto);
              }
            })
            .withFailureHandler(function(error) {
              if (loaderElement) loaderElement.style.display = 'none';
              if (imgElement) {
                imgElement.alt = "Fallo al cargar: " + idFoto;
                imgElement.style.display = '';
              }
              console.error("Fallo al llamar a getImageAsBase64 para " + idFoto + ": " + JSON.stringify(error));
              showMessage("Error cargando imagen: " + idFoto);
            })
            .getImageAsBase64(idFoto);
        });
        photoElements = Array.from(siteDetailContainer.querySelectorAll('.carousel-slide'));
        currentPhotoIndex = 0;
        updatePhotoDisplay(); 
      }

      if (breadcrumbs.length > 0 && breadcrumbs[breadcrumbs.length -1].level !== 'sitios') {
          console.warn("Migas de pan inconsistentes al mostrar detalle. Reconstruyendo.");
          const tempFiltersForSiteList = {...currentFilters};
          delete tempFiltersForSiteList.sitio;
          breadcrumbs = breadcrumbs.filter(b => b.level !== 'sitio_detail');
          if(currentFilters.barrio && !breadcrumbs.find(b => b.level === 'sitios' && b.filters.barrio === currentFilters.barrio)) {
             breadcrumbs.push({ label: currentFilters.barrio, level: 'sitios', filters: tempFiltersForSiteList });
          }
      }
      breadcrumbs.push({ label: sitioData.Nombre, level: 'sitio_detail', filters: {...currentFilters, sitio: sitioData.Nombre} });
      updateBreadcrumbs();
    }
    
    function updatePhotoDisplay() {
        if (!photoElements || photoElements.length === 0) return;
        photoElements.forEach((slide, index) => {
            if (index === currentPhotoIndex) {
                slide.classList.add('active');
            } else {
                slide.classList.remove('active');
            }
        });
        const prevButton = siteDetailContainer.querySelector('.carousel-button.prev');
        const nextButton = siteDetailContainer.querySelector('.carousel-button.next');
        if (prevButton) prevButton.disabled = currentPhotoIndex === 0;
        if (nextButton) nextButton.disabled = currentPhotoIndex === photoElements.length - 1;
    }

    function changePhoto(direction) {
        if (!photoElements || photoElements.length === 0) return;
        const newIndex = currentPhotoIndex + direction;
        if (newIndex >= 0 && newIndex < photoElements.length) {
            currentPhotoIndex = newIndex;
            updatePhotoDisplay();
        }
    }

    function capitalizeFirstLetter(string) {
      if (!string) return string;
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function loadAutonomias() {
      showLoader();
      currentLevel = 'autonomias';
      currentFilters = {};
      pageTitle.textContent = 'Autonomía / País';
      breadcrumbs = [{label: 'Inicio', level: 'autonomias', filters: {}}];
      updateBreadcrumbs();
      google.script.run
        .withSuccessHandler(autonomias => {
          if (autonomias && autonomias.length === 1 && autonomias[0] && autonomias[0].Autonomia) {
            loadProvincias(autonomias[0].Autonomia);
          } else {
            renderList(autonomias, 'autonomia');
            hideLoader(); 
          }
        })
        .withFailureHandler(err => {
          showMessage('Error al cargar autonomías: ' + err.message);
          hideLoader();
        })
        .getAutonomias(); 
    }

    function loadProvincias(autonomia) {
      showLoader();
      currentLevel = 'provincias';
      currentFilters = { autonomia: autonomia };
      pageTitle.textContent = "Provincias de " + autonomia;
      breadcrumbs = breadcrumbs.slice(0, 1); 
      breadcrumbs.push({label: autonomia, level: 'provincias', filters: {autonomia: autonomia}});
      updateBreadcrumbs();
      google.script.run
        .withSuccessHandler(provincias => {
          if (provincias && provincias.length === 1 && provincias[0] && provincias[0].Provincia) {
            loadCiudades(provincias[0].Provincia);
          } else {
            renderList(provincias, 'provincia');
            hideLoader();
          }
        })
        .withFailureHandler(err => {
          showMessage('Error al cargar provincias: ' + err.message);
          hideLoader();
        })
        .getProvincias(autonomia); 
    }

    function loadCiudades(provincia) {
      showLoader();
      currentLevel = 'ciudades';
      currentFilters.provincia = provincia; 
      pageTitle.textContent = "Ciudades de " + provincia;
      breadcrumbs = breadcrumbs.slice(0, 2); 
      breadcrumbs.push({label: provincia, level: 'ciudades', filters: {...currentFilters}});
      updateBreadcrumbs();
      google.script.run
        .withSuccessHandler(ciudades => {
          if (ciudades && ciudades.length === 1 && ciudades[0] && ciudades[0].Ciudad) {
            loadBarrios(ciudades[0].Ciudad);
          } else {
            renderList(ciudades, 'ciudad');
            hideLoader();
          }
        })
        .withFailureHandler(err => {
          showMessage('Error al cargar ciudades: ' + err.message);
          hideLoader();
        })
        .getCiudades(provincia); 
    }

    function loadBarrios(ciudad) {
      showLoader();
      currentLevel = 'barrios';
      currentFilters.ciudad = ciudad; 
      pageTitle.textContent = "Barrios de " + ciudad;
      breadcrumbs = breadcrumbs.slice(0, 3); 
      breadcrumbs.push({label: ciudad, level: 'barrios', filters: {...currentFilters}});
      updateBreadcrumbs();
      google.script.run
        .withSuccessHandler(barrios => {
          if (barrios && barrios.length === 1 && barrios[0] && barrios[0].Barrio) {
            loadSitios(barrios[0].Barrio);
          } else {
            renderList(barrios, 'barrio');
            hideLoader();
          }
        })
        .withFailureHandler(err => {
          showMessage('Error al cargar barrios: ' + err.message);
          hideLoader();
        })
        .getBarrios(ciudad); 
    }
    
    function loadSitios(barrio) {
      showLoader();
      currentLevel = 'sitios'; 
      currentFilters.barrio = barrio; 
      pageTitle.textContent = "Sitios de " + barrio;
      breadcrumbs = breadcrumbs.slice(0, 4); 
      breadcrumbs.push({label: barrio, level: 'sitios', filters: {...currentFilters}}); 
      updateBreadcrumbs();
      google.script.run
        .withSuccessHandler(sitios => {
          renderList(sitios, 'sitio'); 
          hideLoader(); 
        })
        .withFailureHandler(err => {
          showMessage('Error al cargar sitios: ' + err.message);
          hideLoader();
        })
        .getSitios(barrio); 
    }

    // Carga Inicial
    document.addEventListener('DOMContentLoaded', () => {
      loadAutonomias();
    });

  </script>
</body>
</html>
