<script>
      // Elementos del DOM
      const gastronomiaContent = document.getElementById('gastronomiaContent');
      const turismoContent = document.getElementById('turismoContent');
      const cartelesContent = document.getElementById('cartelesContent');
      const heroSection = document.getElementById('heroSection');
      const contentSections = document.querySelectorAll('.content-section');
      const navLinks = document.querySelectorAll('nav a[data-section], #mobileMenu a[data-section]');
      const homeLink = document.getElementById('homeLink');
      const mobileMenuButton = document.getElementById('mobileMenuButton');
      const mobileMenu = document.getElementById('mobileMenu');
      const globalLoadingIndicator = document.getElementById('globalLoadingIndicator');
      
      document.getElementById('currentYear').textContent = new Date().getFullYear();

      // Estructura de datos principal de la aplicación
      let appData = {
          gastronomia: [],
          turismo: [],
          carteles: [] 
      };
      // Rutas de navegación actuales para las migas de pan
      let currentGastronomiaPath = [];
      let currentTurismoPath = [];

      // --- Configuración para Cargar Datos desde Google Apps Script Web App ---
      // ¡¡¡REEMPLAZA ESTA URL CON LA URL DE TU APLICACIÓN WEB DESPLEGADA!!!
      const APPS_SCRIPT_WEB_APP_URL = 'URL_DE_TU_APLICACION_WEB_DE_APPS_SCRIPT_AQUI'; 

      // --- Inicio: Funciones para Cargar y Procesar Datos ---

      /**
       * Convierte una valoración numérica (ej. 0-20) a una cadena de estrellas (0-5).
       * @param {string|number} numericVal - El valor numérico de la hoja de cálculo.
       * @returns {string} Una cadena de caracteres de estrellas.
       */
      function convertNumericToStars(numericVal) {
          const val = parseInt(numericVal, 10);
          if (isNaN(val) || val <= 0) return ""; // Si no es un número válido o es 0 o menos, no muestra estrellas
          
          // Asumimos una escala donde 20 es el máximo (5 estrellas).
          // Ajusta esta lógica si tu escala de valoración es diferente.
          // Por ejemplo, si 20 -> 5 estrellas, 16 -> 4 estrellas, etc.
          const starsCount = Math.round(val / 4); 
          return '⭐'.repeat(Math.min(Math.max(0, starsCount), 5)); // Asegura entre 0 y 5 estrellas
      }

      /**
       * Transforma los datos crudos (array de arrays de Google Sheets, ya sin encabezados)
       * a la estructura anidada de appData, usando los índices de columna de tu hoja.
       * @param {Array<Array<string>>} dataRows - Array de filas de datos (sin encabezados).
       */
      function transformData(dataRows) {
          const newAppData = {
              gastronomia: [],
              turismo: [],
              carteles: [] // Los carteles no se procesan desde esta lógica, necesitarían su propia columna "Tipo"
          };
          const gastronomiaMap = new Map(); // Ayuda a construir la estructura anidada

          dataRows.forEach(row => {
              // Verifica que la fila tenga suficientes datos y un nombre de lugar
              if (!row || row.length < 18 || !row[4] || row[4].trim() === '') { 
                  // console.warn("Fila incompleta o sin nombre de lugar, saltando:", row);
                  return; 
              }

              // Mapeo de índices de columna a variables (0-indexed)
              const autonomia = row[0] ? row[0].trim() : '';         // Col A
              const provinciaNombre = row[1] ? row[1].trim() : '';   // Col B
              const ciudadNombre = row[2] ? row[2].trim() : '';      // Col C
              const barrioNombre = row[3] ? row[3].trim() : '';      // Col D
              const nombreLugar = row[4] ? row[4].trim() : '';       // Col E
              const descripcion = row[5] ? row[5].trim() : '';       // Col F (Nota)
              const direccion = row[6] ? row[6].trim() : '';         // Col G
              const horario = row[7] ? row[7].trim() : '';           // Col H
              const pintxoTapa = row[8] ? row[8].trim() : '';        // Col I
              const mapLink = row[9] ? row[9].trim() : '';           // Col J
              const facebookUrl = row[10] ? row[10].trim() : '';     // Col K
              const instagramUrl = row[11] ? row[11].trim() : '';    // Col L
              const webUrl = row[12] ? row[12].trim() : '';          // Col M
              
              const fotos = [];
              if (row[13] && row[13].trim() !== '') fotos.push(row[13].trim()); // Col N (Foto1)
              if (row[14] && row[14].trim() !== '') fotos.push(row[14].trim()); // Col O (Foto2)
              if (row[15] && row[15].trim() !== '') fotos.push(row[15].trim()); // Col P (Foto3)
              if (row[16] && row[16].trim() !== '') fotos.push(row[16].trim()); // Col Q (Foto4)
              
              const tipoLugarSheet = row[17] ? row[17].trim() : '';    // Col R (Tipo Lugar)
              const valoracionNumerica = row[18] ? row[18].trim() : ''; // Col S (Valoracion numérica)

              const valoracionEstrellas = convertNumericToStars(valoracionNumerica);

              // Construye el array de redes sociales
              const rrss = [];
              if (instagramUrl) rrss.push({ nombre: "Instagram", url: instagramUrl, icon: "photo_camera" });
              if (facebookUrl) rrss.push({ nombre: "Facebook", url: facebookUrl, icon: "forum" }); // 'forum' como icono genérico para FB
              if (webUrl) rrss.push({ nombre: "Web", url: webUrl, icon: "language" });

              // Determina el tipo de lugar para la app y la estructura de datos
              let appDataTipo = "";
              if (tipoLugarSheet.toLowerCase() === "restaurante") appDataTipo = "Restaurante Tradicional";
              else if (tipoLugarSheet.toLowerCase() === "bar") appDataTipo = "Bar de Pintxos";
              else if (tipoLugarSheet.toLowerCase() === "tienda") appDataTipo = "Tienda";
              else if (tipoLugarSheet.toLowerCase() === "turismo") appDataTipo = "Interés Turístico";
              else {
                  // console.warn(`Tipo de lugar desconocido '${tipoLugarSheet}' para '${nombreLugar}', saltando fila.`);
                  return; // Salta esta fila si el tipo no es reconocido
              }

              // Objeto base para cada lugar
              const lugarBase = {
                  id: `item-${Math.random().toString(36).substr(2, 9)}`, // ID único generado
                  nombre: nombreLugar,
                  tipo: appDataTipo,
                  valoracion: valoracionEstrellas,
                  descripcion: descripcion,
                  direccion: direccion,
                  horario: horario,
                  mapLink: mapLink,
                  fotos: fotos,
                  rrss: rrss,
              };

              // Añade pintxo/tapa si aplica
              if (appDataTipo === "Restaurante Tradicional" || appDataTipo === "Bar de Pintxos") {
                if (pintxoTapa) lugarBase.pintxo_tapa = pintxoTapa;
              }

              // Clasifica el lugar en gastronomía o turismo
              if (appDataTipo === "Restaurante Tradicional" || appDataTipo === "Bar de Pintxos" || appDataTipo === "Tienda") {
                  // Requiere todos los niveles geográficos para gastronomía
                  if (!autonomia || !provinciaNombre || !ciudadNombre || !barrioNombre) {
                      // console.warn(`Datos geográficos incompletos para gastronomía/tienda '${nombreLugar}', saltando.`);
                      return;
                  }
                  // Construye la estructura anidada para gastronomía
                  let comunidad = gastronomiaMap.get(autonomia);
                  if (!comunidad) {
                      comunidad = { nombre: autonomia, provincias: new Map() };
                      gastronomiaMap.set(autonomia, comunidad);
                      newAppData.gastronomia.push({ nombre: autonomia, provincias: [] }); // Referencia para el array final
                  }
                  let finalComunidad = newAppData.gastronomia.find(c => c.nombre === autonomia);

                  let provincia = comunidad.provincias.get(provinciaNombre);
                  if (!provincia) {
                      provincia = { nombre: provinciaNombre, ciudades: new Map() };
                      comunidad.provincias.set(provinciaNombre, provincia);
                      finalComunidad.provincias.push({ nombre: provinciaNombre, ciudades: [] });
                  }
                  let finalProvincia = finalComunidad.provincias.find(p => p.nombre === provinciaNombre);

                  let ciudad = provincia.ciudades.get(ciudadNombre);
                  if (!ciudad) {
                      ciudad = { nombre: ciudadNombre, barrios: new Map() };
                      provincia.ciudades.set(ciudadNombre, ciudad);
                      finalProvincia.ciudades.push({ nombre: ciudadNombre, barrios: [] });
                  }
                  let finalCiudad = finalProvincia.ciudades.find(c => c.nombre === ciudadNombre);
                  
                  let barrio = ciudad.barrios.get(barrioNombre);
                  if (!barrio) {
                      barrio = { nombre: barrioNombre, lugares: [] };
                      ciudad.barrios.set(barrioNombre, barrio);
                      finalCiudad.barrios.push(barrio); // El barrio ya tiene la estructura final
                  }
                  barrio.lugares.push(lugarBase);

              } else if (appDataTipo === "Interés Turístico") {
                   // Requiere al menos autonomía y ciudad para turismo
                   if (!autonomia || !ciudadNombre ) {
                      // console.warn(`Datos geográficos incompletos para turismo '${nombreLugar}', saltando.`);
                      return;
                  }
                  newAppData.turismo.push({
                      ...lugarBase,
                      region: autonomia, // Para turismo, Autonomía es la Región
                      localidad: ciudadNombre // Ciudad es la Localidad
                  });
              }
          });
          
          // Limpia los Maps de la estructura de gastronomiaMap para que appData solo tenga arrays
          newAppData.gastronomia.forEach(com => {
              com.provincias.forEach(prov => {
                  prov.ciudades.forEach(ciu => { /* La estructura de barrios ya es un array de lugares */ });
              });
          });
          return newAppData;
      }

      /**
       * Carga los datos desde la aplicación web de Google Apps Script.
       */
      async function loadDataAndInitialize() {
          if (APPS_SCRIPT_WEB_APP_URL === 'URL_DE_TU_APLICACION_WEB_DE_APPS_SCRIPT_AQUI' || APPS_SCRIPT_WEB_APP_URL.trim() === '') {
              console.error("Por favor, configura la APPS_SCRIPT_WEB_APP_URL en el script.");
              heroSection.innerHTML += '<p class="text-red-500 text-center mt-4">Error: URL de la aplicación web de Apps Script no configurada.</p>';
              globalLoadingIndicator.classList.add('hidden');
              appData = { gastronomia: [], turismo: [], carteles: [] }; // Datos vacíos
              initializeUI(); // Llama para que la UI sepa que no hay datos
              return;
          }

          globalLoadingIndicator.classList.remove('hidden'); // Mostrar indicador de carga
          heroSection.classList.add('hidden'); // Ocultar hero mientras carga

          try {
              const response = await fetch(APPS_SCRIPT_WEB_APP_URL);
              if (!response.ok) {
                  let errorMsg = `Error al cargar datos desde Apps Script: ${response.status} ${response.statusText}.`;
                  try {
                      const errorBody = await response.json(); // Intenta obtener más detalles del error
                      errorMsg += ` Detalles: ${errorBody.error || JSON.stringify(errorBody)}`;
                  } catch (e) { /* No se pudo parsear el cuerpo del error como JSON */ }
                  throw new Error(errorMsg);
              }
              const result = await response.json(); // Parsea la respuesta JSON del Apps Script
              
              if (result.error) { // Si el JSON del Apps Script contiene un campo 'error'
                  throw new Error(`Error devuelto por Apps Script: ${result.error}`);
              }

              if (result.values && result.values.length > 0) {
                  // Tu Apps Script ya hace data.shift(), por lo que result.values son solo los datos.
                  appData = transformData(result.values); 
                  console.log("Datos cargados y transformados desde Apps Script:", appData);
              } else {
                  console.warn("No se encontraron datos (result.values) en la respuesta de Apps Script o está vacío.");
                  appData = { gastronomia: [], turismo: [], carteles: [] }; // Asegurar que appData está definido
              }
              initializeUI(); // Inicializa la UI con los datos cargados (o vacíos)

          } catch (error) {
              console.error('Error al cargar o procesar los datos desde Apps Script:', error);
              // Muestra el error en la sección hero para que el usuario lo vea
              heroSection.innerHTML = `<p class="text-red-600 text-center py-10 text-lg">Error al cargar los datos: ${error.message}.<br>Por favor, revisa la URL y el despliegue de tu Apps Script, y asegúrate de que la hoja de cálculo es accesible.</p>`;
              heroSection.classList.remove('hidden');
              appData = { gastronomia: [], turismo: [], carteles: [] }; // Datos vacíos en caso de error
              initializeUI(); // Llama para que la UI sepa que hubo un error
          } finally {
            globalLoadingIndicator.classList.add('hidden'); // Ocultar indicador de carga
            // Si no hay datos y no hubo un error explícito mostrado en hero, muestra el hero por defecto
            if (appData.gastronomia.length === 0 && appData.turismo.length === 0 && appData.carteles.length === 0 && !heroSection.innerHTML.includes('text-red-600')) {
                heroSection.classList.remove('hidden');
            }
          }
      }
      
      /**
       * Inicializa la interfaz de usuario. Se llama después de que los datos se han intentado cargar.
       */
      function initializeUI() {
        navigateToSection('hero'); // Navega a la sección de inicio por defecto
      }

      // --- Funciones de renderizado y navegación (sin cambios significativos, deben estar completas) ---

      async function callGeminiAPI(prompt, lugarId) {
          const geminiResponseEl = document.getElementById(`gemini-response-${lugarId}`);
          const geminiButton = document.getElementById(`gemini-btn-${lugarId}`);
          if (!geminiResponseEl || !geminiButton) return;

          geminiButton.disabled = true;
          geminiButton.innerHTML = '<div class="loader"></div> Procesando...';
          geminiResponseEl.innerHTML = ''; 
          geminiResponseEl.classList.remove('hidden');

          let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiKey = ""; 
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          try {
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              if (!response.ok) {
                  throw new Error(`Error de API Gemini: ${response.status}`);
              }
              const result = await response.json();
              
              if (result.candidates && result.candidates.length > 0 &&
                  result.candidates[0].content && result.candidates[0].content.parts &&
                  result.candidates[0].content.parts.length > 0) {
                  const text = result.candidates[0].content.parts[0].text;
                  geminiResponseEl.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
              } else {
                  geminiResponseEl.innerHTML = '<p>No se pudo obtener una respuesta creativa esta vez. Inténtalo de nuevo más tarde.</p>';
              }
          } catch (error) {
              console.error('Error llamando a la API de Gemini:', error);
              geminiResponseEl.innerHTML = `<p>Hubo un problema al contactar con el servicio de IA: ${error.message}.</p>`;
          } finally {
              geminiButton.disabled = false;
              geminiButton.innerHTML = '<span class="material-symbols-outlined mr-1">auto_awesome</span>Descubrir Algo Más';
          }
      }

      function updateBreadcrumb(type) {
          const breadcrumbContainer = document.getElementById(`${type}Breadcrumb`);
          if (!breadcrumbContainer) return; 
          const path = type === 'gastronomia' ? currentGastronomiaPath : currentTurismoPath;
          breadcrumbContainer.innerHTML = ''; 
          
          const homeSpan = document.createElement('span');
          homeSpan.textContent = 'Inicio';
          homeSpan.classList.add('cursor-pointer', 'hover:underline', 'breadcrumb-item');
          homeSpan.onclick = () => navigateToSection(type, true);
          breadcrumbContainer.appendChild(homeSpan);

          path.forEach((item, index) => {
              const itemSpan = document.createElement('span');
              itemSpan.textContent = item.nombre || item; 
              itemSpan.classList.add('breadcrumb-item');
              if (index < path.length -1) {
                  itemSpan.classList.add('cursor-pointer', 'hover:underline');
                  itemSpan.onclick = () => {
                      if (type === 'gastronomia') {
                          currentGastronomiaPath = currentGastronomiaPath.slice(0, index + 1);
                          renderGastronomiaLevel(currentGastronomiaPath);
                      } else { 
                          currentTurismoPath = currentTurismoPath.slice(0, index + 1);
                          renderTurismoLevel(currentTurismoPath);
                      }
                  };
              } else {
                  itemSpan.classList.add('font-semibold', 'text-[#E46F44]');
              }
              breadcrumbContainer.appendChild(document.createTextNode(' ')); 
              breadcrumbContainer.appendChild(itemSpan);
          });
      }

      function createInteractiveCard(item, type) {
          const card = document.createElement('div');
          card.className = 'bg-white rounded-lg shadow-md p-4 md:p-6 cursor-pointer transition-all duration-300 card-hover flex flex-col';
          card.innerHTML = `<h3 class="text-xl font-semibold font-display text-[#1A385A] mb-2">${item.nombre}</h3>`;
          if (type === 'gastronomia') {
              card.onclick = () => {
                  currentGastronomiaPath.push(item);
                  renderGastronomiaLevel(currentGastronomiaPath);
              };
          } else if (type === 'turismoRegion') { 
                card.onclick = () => {
                  currentTurismoPath.push(item.nombre); 
                  renderTurismoLevel(currentTurismoPath);
              };
          }
          return card;
      }
      
      function renderLugarCard(lugar) {
          let currentImageIndex = 0;
          const imageGalleryId = `gallery-${lugar.id}`;
          const prevButtonId = `prev-${lugar.id}`;
          const nextButtonId = `next-${lugar.id}`;
          const imageDisplayId = `img-${lugar.id}`;
          const geminiButtonId = `gemini-btn-${lugar.id}`;
          const geminiResponseId = `gemini-response-${lugar.id}`;
          const walkDirectionsButtonId = `walk-dir-btn-${lugar.id}`;

          let rrssLinks = (lugar.rrss || []).map(rs => 
              `<a href="${rs.url}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center bg-[#022831] hover:bg-[#E46F44] text-white text-xs px-3 py-2 rounded-full mr-2 mb-2 transition-colors duration-300">
                  <span class="material-symbols-outlined mr-1 text-sm">${rs.icon}</span> ${rs.nombre}
                </a>`
          ).join('');

          const card = document.createElement('div');
          card.className = 'bg-white rounded-lg shadow-xl p-4 md:p-6 flex flex-col space-y-3 col-span-1 md:col-span-2 lg:col-span-3';
          card.innerHTML = `
              <div id="${imageGalleryId}" class="relative w-full aspect-video rounded-lg mb-3 shadow-md overflow-hidden">
                  <img id="${imageDisplayId}" src="${(lugar.fotos && lugar.fotos.length > 0) ? lugar.fotos[0] : 'https://placehold.co/600x338/cccccc/ffffff?text=Imagen+no+disponible'}" alt="${lugar.nombre}" class="absolute top-0 left-0 w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x338/cccccc/ffffff?text=Imagen+no+disponible';">
                  ${(lugar.fotos && lugar.fotos.length > 1) ? `
                      <button id="${prevButtonId}" class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-[#1A385A] bg-opacity-70 text-white p-2 rounded-full hover:bg-opacity-100 focus:outline-none z-10"><span class="material-symbols-outlined">arrow_back_ios</span></button>
                      <button id="${nextButtonId}" class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-[#1A385A] bg-opacity-70 text-white p-2 rounded-full hover:bg-opacity-100 focus:outline-none z-10"><span class="material-symbols-outlined">arrow_forward_ios</span></button>
                  ` : ''}
              </div>
              <h3 class="text-2xl font-bold font-display text-[#E46F44]">${lugar.nombre || 'Nombre no disponible'}</h3>
              <p class="text-lg text-yellow-500">${lugar.valoracion || ''}</p>
              <p class="text-sm text-gray-700"><strong class="font-semibold text-[#1A385A]">Dirección:</strong> ${lugar.direccion || 'No disponible'}</p>
              <p class="text-sm text-gray-700"><strong class="font-semibold text-[#1A385A]">Horario:</strong> ${lugar.horario || 'No disponible'}</p>
              <p class="text-sm text-gray-700 mt-1">${lugar.descripcion || ''}</p>
              ${lugar.pintxo_tapa ? `<p class="text-sm text-gray-700"><strong class="font-semibold text-[#1A385A]">Especialidad:</strong> ${lugar.pintxo_tapa}</p>` : ''}
              <div class="mt-3 flex flex-wrap items-center">
                  ${rrssLinks}
                  ${lugar.mapLink ? `<a href="${lugar.mapLink}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-2 rounded-full mr-2 mb-2 transition-colors duration-300">
                      <span class="material-symbols-outlined mr-1 text-sm">location_on</span> Ver en Mapa
                  </a>` : ''}
                  ${lugar.direccion ? `<button id="${walkDirectionsButtonId}" class="inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded-full mr-2 mb-2 transition-colors duration-300">
                      <span class="material-symbols-outlined mr-1 text-sm">directions_walk</span> Cómo ir andando
                  </button>`: ''}
              </div>
              <div class="mt-4">
                  <button id="${geminiButtonId}" class="bg-[#AAB624] hover:bg-[#8f9a1e] text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out flex items-center justify-center text-sm w-full md:w-auto">
                      <span class="material-symbols-outlined mr-1">auto_awesome</span>Descubrir Algo Más
                  </button>
                  <div id="${geminiResponseId}" class="gemini-response-area hidden mt-3"></div>
              </div>
          `;
          
          setTimeout(() => { 
              if (lugar.fotos && lugar.fotos.length > 1) {
                  const imgElement = document.getElementById(imageDisplayId);
                  if(imgElement) { 
                      document.getElementById(prevButtonId)?.addEventListener('click', () => {
                          currentImageIndex = (currentImageIndex - 1 + lugar.fotos.length) % lugar.fotos.length;
                          imgElement.src = lugar.fotos[currentImageIndex];
                      });
                      document.getElementById(nextButtonId)?.addEventListener('click', () => {
                          currentImageIndex = (currentImageIndex + 1) % lugar.fotos.length;
                          imgElement.src = lugar.fotos[currentImageIndex];
                      });
                  }
              }
              const geminiBtn = document.getElementById(geminiButtonId);
              if(geminiBtn){
                  geminiBtn.addEventListener('click', () => {
                      const nombreGeografico = lugar.localidad || (currentGastronomiaPath.length > 0 ? currentGastronomiaPath[currentGastronomiaPath.length -1].nombre : '') || (currentTurismoPath.length > 0 ? currentTurismoPath[0] : 'esta área');
                      const promptType = `Dame una sugerencia especial o un dato curioso sobre ${lugar.nombre}, un ${lugar.tipo} en ${nombreGeografico}. Sé breve y creativo.`;
                      callGeminiAPI(promptType, lugar.id);
                  });
              }

              const walkBtn = document.getElementById(walkDirectionsButtonId);
              if(walkBtn && lugar.direccion) {
                  walkBtn.addEventListener('click', () => {
                      if (!navigator.geolocation) {
                          walkBtn.innerHTML = '<span class="material-symbols-outlined mr-1 text-sm">error</span> Geolocalización no soportada';
                          setTimeout(() => { walkBtn.innerHTML = '<span class="material-symbols-outlined mr-1 text-sm">directions_walk</span> Cómo ir andando'; }, 3000);
                          return;
                      }

                      walkBtn.disabled = true;
                      walkBtn.innerHTML = '<div class="button-loader"></div> Obteniendo ubicación...';

                      navigator.geolocation.getCurrentPosition(
                          (position) => {
                              const lat = position.coords.latitude;
                              const lon = position.coords.longitude;
                              const destination = encodeURIComponent(lugar.direccion);
                              const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${lat},${lon}&destination=${destination}&travelmode=walking`;
                              window.open(mapsUrl, '_blank');
                              walkBtn.disabled = false;
                              walkBtn.innerHTML = '<span class="material-symbols-outlined mr-1 text-sm">directions_walk</span> Cómo ir andando';
                          },
                          (error) => {
                              console.error("Error obteniendo ubicación: ", error);
                              let errorMessageText = 'No se pudo obtener ubicación.';
                              if (error.code === error.PERMISSION_DENIED) {
                                  errorMessageText = 'Permiso de ubicación denegado.';
                              }
                              walkBtn.disabled = false;
                              const originalButtonText = '<span class="material-symbols-outlined mr-1 text-sm">directions_walk</span> Cómo ir andando';
                              walkBtn.innerHTML = `<span class="material-symbols-outlined mr-1 text-sm">error</span> ${errorMessageText}`;
                              setTimeout(() => { walkBtn.innerHTML = originalButtonText; }, 5000);
                          }
                      );
                  });
              }

          }, 0);
          return card;
      }

      function renderGastronomiaLevel(path) {
          gastronomiaContent.innerHTML = ''; 
          updateBreadcrumb('gastronomia');
          let currentLevelData;

          if (path.length === 0) { 
              currentLevelData = appData.gastronomia;
              if (!currentLevelData || currentLevelData.length === 0) {
                  gastronomiaContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay datos de gastronomía disponibles.</p>'; return;
              }
              currentLevelData.forEach(comunidad => gastronomiaContent.appendChild(createInteractiveCard(comunidad, 'gastronomia')));
          } else if (path.length === 1) { 
              currentLevelData = path[0].provincias;
               if (!currentLevelData || currentLevelData.length === 0) {
                  gastronomiaContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay provincias en esta comunidad.</p>'; return;
              }
              currentLevelData.forEach(provincia => gastronomiaContent.appendChild(createInteractiveCard(provincia, 'gastronomia')));
          } else if (path.length === 2) { 
              currentLevelData = path[1].ciudades;
              if (!currentLevelData || currentLevelData.length === 0) {
                  gastronomiaContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay ciudades en esta provincia.</p>'; return;
              }
              currentLevelData.forEach(ciudad => gastronomiaContent.appendChild(createInteractiveCard(ciudad, 'gastronomia')));
          } else if (path.length === 3) { 
              currentLevelData = path[2].barrios;
              if (!currentLevelData || currentLevelData.length === 0) {
                  gastronomiaContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay barrios en esta ciudad.</p>'; return;
              }
              currentLevelData.forEach(barrio => gastronomiaContent.appendChild(createInteractiveCard(barrio, 'gastronomia')));
          } else if (path.length === 4) { 
              currentLevelData = path[3].lugares;
              if (currentLevelData && currentLevelData.length > 0) {
                  currentLevelData.forEach(lugar => gastronomiaContent.appendChild(renderLugarCard(lugar)));
              } else {
                  gastronomiaContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay lugares en esta selección.</p>';
              }
          }
      }
      
      function renderTurismoLevel(path) {
          turismoContent.innerHTML = '';
          updateBreadcrumb('turismo');

          if (path.length === 0) { 
              if (!appData.turismo || appData.turismo.length === 0) {
                  turismoContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay destinos turísticos disponibles.</p>'; return;
              }
              const regions = [...new Set(appData.turismo.map(item => item.region).filter(Boolean))];
              regions.forEach(regionName => {
                  const regionCard = createInteractiveCard({ nombre: regionName }, 'turismoRegion');
                  turismoContent.appendChild(regionCard);
              });
                if (regions.length === 0) {
                  turismoContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay regiones turísticas definidas.</p>';
              }
          } else if (path.length === 1) { 
              const selectedRegion = path[0];
              const placesInRegion = appData.turismo.filter(item => item.region === selectedRegion);
              if (placesInRegion.length > 0) {
                  placesInRegion.forEach(lugar => turismoContent.appendChild(renderLugarCard(lugar)));
              } else {
                  turismoContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay lugares en esta región.</p>';
              }
          }
      }

      function renderCarteles() {
          cartelesContent.innerHTML = '';
          // Los carteles no se cargan desde la hoja de cálculo con la lógica actual.
          // Si quieres añadir carteles, deberías hacerlo directamente en appData.carteles
          // o modificar tu hoja y el script para incluir un tipo "Cartel".
          if (!appData.carteles || appData.carteles.length === 0) {
              appData.carteles = [ // Ejemplo de datos de carteles si los quieres estáticos
                  { id: "c1", foto: "https://placehold.co/400x300/FF6F61/FFFFFF?text=Cartel+Divertido+1", caption: "Encontrado en un pueblo perdido." },
                  { id: "c2", foto: "https://placehold.co/400x300/87DCF0/000000?text=Señal+Tráfico+Original+2", caption: "¡Cuidado con los patos!" }
              ];
          }
          if (!appData.carteles || appData.carteles.length === 0){
             cartelesContent.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay carteles curiosos disponibles.</p>';
             return;
          }

          appData.carteles.forEach(cartel => {
              const item = document.createElement('figure');
              item.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 card-hover group';
              item.innerHTML = `
                  <img src="${cartel.foto}" alt="${cartel.caption}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/ffffff?text=Cartel+no+disponible';">
                  <figcaption class="p-3 text-xs text-center text-[#022831] bg-gray-50">${cartel.caption}</figcaption>
              `;
              cartelesContent.appendChild(item);
          });
      }
      
      function navigateToSection(sectionId, resetPath = false) {
          heroSection.classList.add('hidden');
          contentSections.forEach(section => section.classList.add('hidden'));
          navLinks.forEach(link => link.classList.remove('active-nav-link'));
          
          mobileMenu.classList.add('hidden'); 

          const activeSection = document.getElementById(sectionId + 'Section');
          if (activeSection) {
              activeSection.classList.remove('hidden');
              document.querySelector(`nav a[data-section="${sectionId}"]`)?.classList.add('active-nav-link');
                const mobileLink = document.querySelector(`#mobileMenu a[data-section="${sectionId}"]`);
                if(mobileLink) mobileLink.classList.add('active-nav-link');


              if (sectionId === 'gastronomia') {
                  if (resetPath) currentGastronomiaPath = [];
                  renderGastronomiaLevel(currentGastronomiaPath);
              } else if (sectionId === 'turismo') {
                  if (resetPath) currentTurismoPath = [];
                  renderTurismoLevel(currentTurismoPath);
              } else if (sectionId === 'carteles') {
                  renderCarteles();
              }
          } else { // Si sectionId es 'hero' o no se encuentra una sección de contenido
              heroSection.classList.remove('hidden');
          }
      }

      navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
              e.preventDefault();
              const sectionId = e.target.closest('a').dataset.section;
              navigateToSection(sectionId, true); 
          });
      });

      homeLink.addEventListener('click', (e) => {
          e.preventDefault();
          navigateToSection('hero'); 
          currentGastronomiaPath = []; 
          currentTurismoPath = [];
      });

      mobileMenuButton.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
      });

      // Iniciar la carga de datos cuando el DOM esté listo
      document.addEventListener('DOMContentLoaded', loadDataAndInitialize);

  </script>
